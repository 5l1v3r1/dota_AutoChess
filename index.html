<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>dotaAutoChess</title>
	<meta name="keywords" content="刀塔自走棋">
	<meta name="description" content="刀塔自走棋">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=1">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <link rel="stylesheet" href="./css/base.css">
    <link rel="stylesheet" href="./css/index.css">
</head>
<body>
	<div class="container" id="container">
		<div class="content">
			<div class="title">
				<h3>一直下棋一直爽</h3>
				<p>偶尔玩会DOTA2，还总能被发现是下棋玩家 ...</p>
			</div>
			<div class="hero-container">
				<div class="hero-list">
					<p class="intro">英雄列表</p>
				</div>
				<div class="race-list">
					<p class="intro">种族列表</p>
				</div>
				<div class="career-list">
					<p class="intro">职业列表</p>
				</div>
				<div class="hero-detail">
					<p class="intro">查询结果</p>
					<div class="tab-container">
						<ul class="tab-nav clearfix"></ul>
						<div class="tab-ctx"></div>
					</div>
				</div>
				<div class="team-buff">
					<p class="intro"><span>全队buff查询</span> <button class="switch">开启(点此开启全队buff查询)</button></p>
					<div class="team-hero"></div>
					<div class="buff-list"></div>
				</div>
			</div>
			<div class="equipment-container"></div>
		</div>
	</div>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<script src="./js/chess.js"></script>
	<script src="./js/starbackground.js"></script>
	<script>
		var chess=new Chess();

		$(function(){
			starBackground();

			var config={
				hero:{
					model:'alone',	// alone or team
					limit:10
				}
			};

			var $content=$('.content');

			function heroContainer(){
				var $heroContainer=$content.find('.hero-container'),
					$heroList=$heroContainer.find('.hero-list'),
					$raceList=$heroContainer.find('.race-list'),
					$careerList=$heroContainer.find('.career-list'),
					$heroDetail=$heroContainer.find('.hero-detail');
				function createList(){
					var $heroCtx=$('<ul></ul>',{'class':'clearfix'}).appendTo($heroList),
						$raceCtx=$('<ul></ul>',{'class':'clearfix'}).appendTo($raceList),
						$careerCtx=$('<ul></ul>',{'class':'clearfix'}).appendTo($careerList);
					var $lastFocus=undefined;
					function addFocus($focus){
						if($lastFocus===undefined){
							$lastFocus=$focus;
							$focus.addClass('focus');
						}else{
							if($lastFocus.is($focus))
								return;
							$lastFocus.removeClass('focus');
							$focus.addClass('focus');
							$lastFocus=$focus;
						}
					}
					var $tab=$heroDetail.find('.tab-container'),
						$tabNav=$tab.children('.tab-nav'),
						$tabCtx=$tab.children('.tab-ctx');
					function tab(aList){
						$tabNav.html('');
						aList.forEach(function(item){
							$('<li></li>',{'class':'fl'+((config.hero.model==='team'&&teamBuff.data[item.hero])?' selected':'')}).html(item.hero).on('click',function(){
								$tabCtx.addClass('ml1em');
								chess._formatHeroHtml(chess.getHero(item.hero),$tabCtx);
								$(this).addClass('focus').siblings().removeClass('focus');
								if(config.hero.model==='team'){
									$heroCtx.children().each(function(){
										if($(this).html()===item.hero){
											$(this).click();
											return;
										}
									});
								}
								
							}).appendTo($tabNav);
						});
						$tabNav.show();

						var $first=$tabNav.children().eq(0);
						$tabCtx.addClass('ml1em');
						chess._formatHeroHtml(chess.getHero($first.html()),$tabCtx);
						$first.addClass('focus').siblings().removeClass('focus');
					}
					for(var h in chess.hero){
						var $li=$('<li></li>',{'class':'fl list-item'});
						(function(heroName){
							$li.html(heroName).on('click',function(){
								if(config.hero.model==='alone'){
									var aHeroList=chess.getHero(heroName);
									$tabNav.hide();
									if(aHeroList.length>1)
										tab(aHeroList);
									else{
										$tabCtx.removeClass('ml1em');
										chess._formatHeroHtml(aHeroList,$tabCtx);
									}
									addFocus($(this));
								}else if(config.hero.model==='team'){
									teamBuff.select($(this));
									$tabNav.children().each(function(){
										if($(this).html()===heroName){
											if(teamBuff.data[heroName])
												$(this).addClass('selected');
											else
												$(this).removeClass('selected');
											return;
										}
									});
								}
							}).appendTo($heroCtx);
						})(h);
					}
					for(var r in chess.race){
						var $li=$('<li></li>',{'class':'fl list-item'});
						(function(raceName){
							$li.html(raceName).on('click',function(){
								var aHeroList=chess.getHeroByRace(raceName);
								$tabNav.hide();
								// if(aHeroList.length>1)
									tab(aHeroList);
								// else{
								// 	$tabCtx.removeClass('ml1em');
								// 	chess._formatHeroHtml(aHeroList,$tabCtx);
								// }
								addFocus($(this));
							}).appendTo($raceCtx);
						})(r);
					}
					for(var c in chess.career){
						var $li=$('<li></li>',{'class':'fl list-item'});
						(function(careerName){
							$li.html(careerName).on('click',function(){
								var aHeroList=chess.getHeroByCareer(careerName);
								$tabNav.hide();
								// if(aHeroList.length>1)
									tab(aHeroList);
								// else{
								// 	$tabCtx.removeClass('ml1em');
								// 	chess._formatHeroHtml(aHeroList,$tabCtx);
								// }
								addFocus($(this));
							}).appendTo($careerCtx);
						})(c);
					}
				}
				createList();

				var	$buff=$content.find('.team-buff'),
					$switch=$buff.find('.switch'),
					$teamHero=$buff.children('.team-hero'),
					$buffList=$buff.children('.buff-list');

				var teamBuff={
					data:{},
					getDataLength:function(){
						var l=0;
						for(var p in this.data)
							l++;
						return l;
					},
					open:function(){
						config.hero.model='team';
					},
					select:function($el){
						if(config.hero.model==='team'){
							var heroName=$el.html();
							if(this.data[heroName]){
								delete this.data[heroName];
								$el.removeClass('selected');
							}else{
								if(this.getDataLength()>=config.hero.limit){
									alert(config.hero.limit+'人口不够你玩啊！');
									return;
								}
								this.data[heroName]=true;
								$el.addClass('selected');
							}
							if(!this.triggerClose){
								var aHeroList=[],
									sHero='',
									sBuff='';
								for(var h in this.data){
									aHeroList.push(h);
									sHero+='<i>'+h+'</i>+';
								}
								sHero=sHero.substr(0,sHero.length-1);
								$teamHero.html(sHero);
								chess._formatBuffHtml(chess.getBuff(aHeroList),$buffList);
							}else if(this.getDataLength()===0){
								$teamHero.html('');
								$buffList.html('');
							}
						}
					},
					triggerClose:false,	// 拒绝关闭时的频繁调用
					close:function(){
						var self=this;
						this.triggerClose=true;
						$heroList.find('li').each(function(){
							if(self.data[$(this).html()])
								$(this).click();
						});
						config.hero.model='alone';
						this.triggerClose=false;
					}
				};

				$switch.on('click',function(){
					if(config.hero.model==='alone'){
						teamBuff.open();
						$(this).html('关闭(点此关闭全队buff查询)').prev().addClass('focus');
					}else if(config.hero.model==='team'){
						teamBuff.close();
						$(this).html('开启(点此开启全队buff查询)').prev().removeClass('focus');
					}
				});
			}
			heroContainer();
		});
	</script>
</body>
</html>
